<link rel="import" href="/app_components/codemirror-editor.html">
<link rel="import" href="/bower_components/iron-icons/image-icons.html">

<dom-model id="category-chooser-dialog">
    <style>
        .iron-selected {
            background-color: #ddd;
        }

        dialog.div {
            padding: 16px;
        }

        iron-overlay-backdrop {
            z-index: 70 !important;
        }

        .modal, .modal.div {
            z-index: 8000 !important;
        }
    </style>
    <template>
        <iron-ajax
                id="category-list-requester"
                url="/rpc/Category.sjs"
                method="POST"
                params='{"method": "list", "start":"0", "limit":2000}'
                handle-as="json"
                on-response="jsonUpdate"
                verbose="" true
                >
        </iron-ajax>
        <paper-dialog id="choose-category">
            <h2>Choose Category</h2>
            <paper-dialog-scrollable>
                <div style="padding-left: 16px;">
                    <iron-selector id="category-selector" class="dialog">
                        <template is="dom-repeat" items="{{list}}">
                            <div>{{item.name}}</div>
                        </template>
                    </iron-selector>
                </div>
            </paper-dialog-scrollable>
            <div class="buttons">
                <paper-button dialog-dismiss>Cancel</paper-button>
                <paper-button dialog-confirm autofocus on-click="choseCategory">OK</paper-button>
            </div>
        </paper-dialog>
    </template>
    <script>
        Polymer({
            is: 'category-chooser-dialog',
            properties: {
                count : Number,
                list  : {
                    type  : Array,
                    value : []
                }
            },
            jsonUpdate: function(event, request) {
                this.count = request.response.count;
                this.list = request.response.list;
                console.dir(this.list);
            },
            choseCategory: function() {
                var chosen = document.getElementById('category-selector').selectedItem.innerHTML;
                console.dir(chosen);
                this.fire('choose', chosen);
            },
            open: function() {
                document.getElementById('category-list-requester').generateRequest();
                document.getElementById('choose-category').open();
            }
        })
    </script>
</dom-model>


<dom-model id="markdown-editor">
    <style>
        iron-icon {
            vertical-align: middle;
            padding-right: 4px;
        }
    </style>

    <template>
        <category-chooser-dialog id="choose-category-dialog" on-choose="choseCategory"></category-chooser-dialog>
        <paper-dialog id="invalid-form">
            <h2>Incomplete Post</h2>

            <p>All required fields are not filled out</p>

            <div class="buttons">
                <paper-button dialog-dismiss>OK</paper-button>
            </div>
        </paper-dialog>

        <div class="horizontal flex layout">
            <div style="flex: .75">
                <paper-material elevation="2" style="padding: 8px">
                    <form is="iron-form" id="blog-post-form">
                        <!--<paper-input-container>-->
                        <!--<label>Title</label>-->
                        <!--<input is="iron-input" id="input-title" name="title" label="Title" on-bind-value-changed="titleChanged" required error-message="This field is required" auto-validate="true">-->
                        <!--</input>-->
                        <!--</paper-input-container>-->
                        <paper-input id="input-title" label="Title" auto-validate="true" required
                                     error-message="This field is required"></paper-input>
                        <paper-input id="input-seo" label="SEO URL" auto-validate="true" required
                                     error-message="This field is required"></paper-input>
                        <div class="horizontal flex layout" style="width: 100%">
                            <paper-input id="input-category" style="flex: 1" name="category" label="Category"
                                         auto-validate="true" required
                                         error-message="This field is required"></paper-input>
                            <paper-button raised style="margin-top: 11px" on-click="chooseCategory">Choose...
                            </paper-button>
                        </div>
                        <paper-input id="tags" label="Tags separated by commas"></paper-input>
                    </form>
                </paper-material>
            </div>
            <paper-material elevation="2" style="padding: 8px">
                <div class="vertical layout" style="flex: .25">
                    <paper-button raised>
                        <iron-icon icon="image:remove-red-eye"></iron-icon>
                        Preview
                    </paper-button>
                    <paper-button raised on-click="saveDraft">
                        <iron-icon icon="save"></iron-icon>
                        Save Draft
                    </paper-button>
                    <paper-button raised on-click="saveLive">
                        <iron-icon icon="check"></iron-icon>
                        Publish
                    </paper-button>
                    <div class="horizontal center-justified layout" style="margin-top: 16px">
                        <paper-toggle-button></paper-toggle-button>
                        <span style="margin-left: 8px">Allow Comments</span>
                    </div>
                </div>
            </paper-material>
        </div>
        <h3>Compose using Markdown:</h3>
        <paper-editor id="input-content" focus-elevation="4" mode="markdown" height="500"></paper-editor>
    </template>
    <script>
        Polymer({
            is             : 'markdown-editor',
            category       : 3,
            chooseCategory : function () {
                var dialog   = document.getElementById('choose-category-dialog'),
                    selector = document.getElementById('category-selector');
                selector.select('' + this.category);
                setTimeout(function () {
                    dialog.open();
                }, 1)
            },
            choseCategory  : function (e, chosen) {
//                var chosen = document.getElementById('category-selector').selectedItem.innerHTML;
//                console.dir(chosen);
                document.getElementById('input-category').value = chosen;
            },
            titleChanged   : function () {
                console.dir(arguments);
            },
            save           : function (published) {
                var serialized = {
                    category      : document.getElementById('input-category').value.trim(),
                    publish       : !!published,
                    seo           : document.getElementById('input-seo').value.trim(),
                    title         : document.getElementById('input-title').value.trim(),
                    contentFormat : 'markdown',
                    content       : document.getElementById('input-content').getValue().trim()
                };

                console.dir({ serialized : serialized });
                if (!serialized.category.length || !serialized.seo.length || !serialized.title.length || !serialized.content.length) {
                    document.getElementById('invalid-form').open();
                }
                alert('saved');
            },
            saveLive       : function () {
                this.save(true);
            },
            saveDraft      : function () {
                this.save(false);
            }

        });
    </script>
</dom-model>
